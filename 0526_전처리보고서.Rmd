---
title: "=__="
subtitle:
author: "참치김밥먹고싶다"
date: "`r format(Sys.Date())`"
output:
  html_document:
    fig_height: 6
    fig_width: 10
    highlight: textmate
    theme: cosmo
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    fig_height: 6
    fig_width: 10
    toc: no
  word_document:
    fig_height: 6
    fig_width: 9
    toc: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=T, fig.align = "center", message=F, warning=F, fig.height = 8, cache=T, dpi = 300, dev = "png")
```

# 05월 26일 기준 code file 구조
 
  (1) movies_확인_0525.R
  (2) movies_탐색_0525.R
  (3) ratings_탐색_0525.R
  (4) tags_탐색_0525.R
  (5) movies_최종데이터구축_0525.R
  (6) movies_모델링_0525.R - 평점기반
  (7) movies_모델링2_0525.R - 장르 기반
  
  (1) ~ (5) = 전처리파일
  (6) ~ (7) = 모델링파일

# 사용자 기반의 추천시스템 모델링

## I 분석환경설정
```{r}
#전처리에 필요한 라이브러리
library(data.table)
library(tidyverse)
library(dplyr)
library(naniar)
library(VIM)
library(DT)
library(ggplot2)
#시각화에 필요한 라이브러리
library(multilinguer)
library(RColorBrewer)
library(wordcloud)
#추천알고리즘 라이브러리
library(recommenderlab)
```

## Ⅱ 데이터이해
```{r}
### 2-1.데이터수집
m <- read.csv('./data/movies.csv',header=T) # m = movies
r <- read.csv('./data/ratings.csv',header=T) # r = ratings
t <- read.csv('./data/tags.csv',header=T) # t = tags

### 2-2.데이터확인
df=m
#df=r
#df=t

glimpse(df)
summary(df)

# 결측치 확인
which(!complete.cases(df)) 
sum(is.na(df)); sum(!is.na(df))
# 이상치 확인
# 중복값 확인
sum(duplicated(df))

#결측치 요약 및 시각화
naniar::miss_case_summary(df) # case : 행 기준
naniar::miss_var_summary(df)  # variable : 변수 기준
naniar::gg_miss_var(df)
#VIM::aggr(df)
```


## Ⅲ 데이터탐색 
  - movies
  - ratings

### 1. 평점 값 탐구

```{r}
unique(r$rating)
# [1] 4.0 5.0 3.0 2.0 1.0 4.5 3.5 2.5 0.5 1.5
```
평점데이터는 0 ~ 5.0 점까지 0.5 단위로 구성된다.

```{r}
table_rating <- table(r$rating)
table_rating
#   0.5     1   1.5     2   2.5     3   3.5     4   4.5     5 
#  1370  2811  1791  7551  5550 20047 13136 26818  8551 13211 
```
각 평점들의 빈도수를 table() 을 통해 파악한다.

```{r}
vector_ratings <- factor(r$rating)
qplot(vector_ratings) + ggtitle("Distribution of the ratings")
```
각 평점들의 빈도수 분포를 시각화한 결과 대부분 평점들은 3점 이상이며 4점이 일반적인 데이터라고 해석 할 수 있다.

### 2. 영화 조회수 
```{r}
df_ratings_means<-r %>% group_by(movieId) %>% summarise(mean_rating = mean(rating), n=n()) %>% arrange(desc(n)) %>% head(10)
barplot(df_ratings_means$n ~ df_ratings_means$movieId)
```
원 데이터에서 user들(610명) 이 가장 많이 조회, 평가한 영화 상위 10개의 랭크는

>
movieId : 356 = Forrest Gump (1994)  포레스트 검프
movieId : 318 = Shawshank Redemption, The (1994)  쇼생크 탈출
movieId : 296 = Pulp Fiction (1994) 펄프 픽션
movieId : 593 = Silence of the Lambs, The (1991) 양들의 침묵
movieId : 2571 = Matrix, The (1999) 매트릭스
movieId : 260 = Star Wars: Episode IV - A New Hope (1977) 스타워즈
movieId : 480 = Jurassic Park (1993) 쥬라기공원 
movieId : 110 = Braveheart (1995) 브레이브하트
movieId : 589 = Terminator 2: Judgment Day (1991) 터미네이터2
movieId : 527 = Schindler's List (1993) 쉰들러 리스트 

순이며 상위 1,2,3순위 랭크는 사용자 절반이상 (300명) 조회,평가한 영화인 점을 알 수 있다.

```{r}
ggplot()+geom_point(mapping=aes(x=mean_rating, y=n), data=df_ratings_means, color = 'blue')
```
각영화의 평균 평점을 구하고 평균 평점에 대해 어떠한 영화들이 많이 조회되었는지
확인 할 수 있다. 사람들이 많이 조회한 영화들은 대부분 3 ~ 4 점 사이에 많이 분포되어 있고 극단값인 0, 5 점은 소수의 사람들에게 평가 받았다고 판단 할 수도 있다.

  => 극단 값으로 평가된 영화들은 제외할 수 있는지??

```{r}
#영화별 평점
# r2 <- r %>% group_by(movieId) %>% summarise(mean_rating = mean(rating), .groups = 'drop') 
# barplot(r2$mean_rating~r2$movieId)
# ggplot(data=r2,aes(x=r2$movieId,y=r2$mean_rating))+geom_point()
# plot(r$movieId, r$mean_rating)
# plot(r$movieId, r$mean_rating,type='l')
# 
# r2 <- as.data.frame(r2)
# head(r2)
# plot(r2$movieId, r2$mean_rating) 
# hist(r2[,2], main = colnames(r2)[1], breaks = 50, xlab = "평점")
```

### 3. Tag 텍스트마이닝
```{r}
t2 <- tolower(t$tag)
sort(t2, decreasing = T) #정렬
t3 <- table(t2)
palete <- brewer.pal(7,"Set3")
wordcloud(names(t3), freq=t3, scale=c(10,1), rot.per=0.1, min.freq=15,
          random.order=F, random.color=T, colors=palete)
```
사용자들이 영화별로 남긴 태그들을 텍스트마이닝한 결과이다. 가장 많은 tag comment를 남긴 keyword들은 atmospheric, superhero, funny, thought-provoking, surreal 정도이다.

### 4. 영화 평점 데이터 (x축 movieId, y축 영화 평점 평균)
```{r}
#movieId를 그룹으로 영화 평점 추출
df_ratings_means <- r %>% group_by(movieId) %>% summarise(mean_rating = mean(rating), n=n())

# 10명 이상 평가한 영화만 그래프에 표시
df_ratings_means_n_over10 <- subset(df_ratings_means,n >=10)
str(df_ratings_means_n_over10)

#View(df_ratings_means_n_over10)
#막대그래프
barplot(df_ratings_means_n_over10$mean_rating~df_ratings_means_n_over10$movieId)

#산점도 그래프
ggplot(data=df_ratings_means_n_over10,aes(x=df_ratings_means_n_over10$movieId,y=df_ratings_means_n_over10$mean_rating))+geom_point()

#산점도 그래프
plot(df_ratings_means_n_over10$movieId, df_ratings_means_n_over10$mean_rating)

#꺾은선 그래프
plot(df_ratings_means_n_over10$movieId,df_ratings_means_n_over10$mean_rating,type='l')
```

## Ⅳ 최종데이터구축

### movies-rating 병합: mr
```{r}
#무비id 오름차순 정렬 후 새 인덱스 부여
m <- m[order(m$movieId),]
m$idx <- 1:nrow(m)

#movies - rating 병합
mr <- merge(m, r, key='movieId', all.y=T)
mr <- mr[,-c(1,7)]
mr <- mr[,-c(2,3)]

sum(duplicated(mr)) #[1] 3
which(duplicated(mr)|duplicated(mr,fromLast=T))
mr[which(duplicated(mr)|duplicated(mr,fromLast=T)),]
mr <- mr[-which(duplicated(mr)|duplicated(mr,fromLast=T)),]
mr <- mr[-c(80209,88669),]
#write.csv(mr, "./data/mr.csv",row.names = F)
```

### 장르 데이터셋 생성
```{r}
# movies에 있는 장르분리 및 장르df생성
g <- data.table()
n <- nrow(m)
for (i in 1:n){
  
  #print(i)
  
  name_index <- as.character(m[i, 1])
  item_index <- as.character(m[i, 3])
  
  item_index_split_temp <- data.frame(strsplit(item_index, split = '\\|'))
  m_temp <- data.frame(cbind(name_index, item_index_split_temp))
  
  names(m_temp) <- c("movieId", "genres")
  
  g <- rbind(g, m_temp)
}
rm(name_index, item_index, item_index_split_temp, m_temp) # delete temp dataset
glimpse(g)
summary(g)

g$movieId <- as.integer(g$movieId)
names(g) <- c("idx","genres")
```

### 장르 데이터 탐색
```{r}
unique(g$genres)
#(no genres listed) -> NA 결측치 처리
g$genres<- gsub("\\(no genres listed\\)", NA, g$genres)
barplot(table(g$genres))
g <- as.data.frame(g)

#write.csv(g, "./data/genres.csv",row.names = F)
```

### movies-genres 병합: mg
```{r}
#장르 기반 - mg 데이터셋 구축
# m$value = 1
# m2 = m[,-c(1,3)]
# mg <- merge(m2, g, key='idx', all.y=T)
# head(mg)
# write.csv(mg, "./data/mg.csv",row.names = F)
```

movies, ratings 을 이용하여 최종 mr, mg 데이터셋 구축완료

  - final_mr, final_mg 와 같은 분석에 들어가는 데이터셋은 분석 할 때 바꿔야함.
  - 혹은 Rdata로 저장.



